---
title: "Harmony_integration_for_practical"
output: html_document
date: "2023-02-15"
---

# Introduction to scRNA-seq integration
The joint analysis of two or more single-cell datasets poses unique challenges. In particular, identifying cell populations that are present across multiple datasets can be problematic under standard workflows. Seurat v4 includes a set of methods to match (or ‘align’) shared cell populations across datasets. These methods first identify cross-dataset pairs of cells that are in a matched biological state (‘anchors’), can be used both to correct for technical differences between datasets (i.e. batch effect correction), and to perform comparative scRNA-seq analysis of across experimental conditions.

Below, we demonstrate methods for scRNA-seq integration as described in Stuart*, Butler* et al, 2019 to perform a comparative analysis of human immune cells (PBMC) in either a resting or interferon-stimulated state.

# Integration goals
The following tutorial is designed to give you an overview of the kinds of comparative analyses on complex cell types that are possible using the Seurat integration procedure. Here, we address a few key goals:

Create an ‘integrated’ data assay for downstream analysis
Identify cell types that are present in both datasets
Obtain cell type markers that are conserved in both control and stimulated cells
Compare the datasets to find cell-type specific responses to stimulation


# Setup the Seurat objects
For convenience, we distribute this dataset through our SeuratData package.

```{r, warning=FALSE}
suppressPackageStartupMessages({
p <- c("tidyverse", "Seurat", "patchwork", "harmony", "glmGamPoi", "sctransform", "MAST", "RColorBrewer")
lapply(p, require, character.only = TRUE)
rm(p)
})

set.seed(117)
```


# reading data
reading h5 files (lymphocyte 5 samples)
```{r}
h5files <- list.files(path = "Lymphocyte_count_h5_files", recursive = T, full.names = T)

for(i in h5files){
  ID <- gsub("_filtered_feature_bc_matrix.h5", "", i)
  ID <- gsub("Lymphocyte_count_h5_files/", "", ID)
  
  assign(ID, Read10X_h5(filename = i, use.names = TRUE, unique.features = TRUE))
}

rm(h5files, i, ID)
```





## Initiating the Seurat S4 object
```{r}
SKN8104896 <- CreateSeuratObject(counts = SKN8104896,
                              project = 'SKN8104896',
                              min.cells = 3,
                              min.features = 200)

SKN8105194 <- CreateSeuratObject(counts = SKN8105194,
                              project = 'SKN8105194',
                              min.cells = 3,
                              min.features = 200)

STDY7388998 <- CreateSeuratObject(counts = STDY7388998,
                              project = 'STDY7388998',
                              min.cells = 3,
                              min.features = 200)

STDY7389006 <- CreateSeuratObject(counts = STDY7389006,
                              project = 'STDY7389006',
                              min.cells = 3,
                              min.features = 200)

STDY7389014 <- CreateSeuratObject(counts = STDY7389014,
                              project = 'STDY7389014',
                              min.cells = 3,
                              min.features = 200)
```


###Quality control and filtering###

#1 #calculate mitochondrial & Filtering
```{r}
SKN8104896$mitopercentage <- PercentageFeatureSet(SKN8104896, pattern = "^MT-")

SKN8105194$mitopercentage <- PercentageFeatureSet(SKN8105194, pattern = "^MT-")

STDY7388998$mitopercentage <- PercentageFeatureSet(STDY7388998, pattern = "^MT-")

STDY7389006$mitopercentage <- PercentageFeatureSet(STDY7389006, pattern = "^MT-")

STDY7389014$mitopercentage <- PercentageFeatureSet(STDY7389014, pattern = "^MT-")
```



```{r}
SKN8104896 <- subset(SKN8104896, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(SKN8104896$nFeature_RNA)*3)+median(SKN8104896$nFeature_RNA) & mitopercentage < 10)

SKN8105194 <- subset(SKN8105194, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(SKN8105194$nFeature_RNA)*3)+median(SKN8105194$nFeature_RNA) & mitopercentage < 10)

STDY7388998 <- subset(STDY7388998, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(STDY7388998$nFeature_RNA)*3)+median(STDY7388998$nFeature_RNA) & mitopercentage < 10)

STDY7389006 <- subset(STDY7389006, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(STDY7389006$nFeature_RNA)*3)+median(STDY7389006$nFeature_RNA) & mitopercentage < 10)

STDY7389014 <- subset(STDY7389014, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(STDY7389014$nFeature_RNA)*3)+median(STDY7389014$nFeature_RNA) & mitopercentage < 10)

```


merge all objects together after filtering
Make sure there are no other objects in global env
check with ls() > to keep the exact same order 

```{r}
lymp <- merge(x = SKN8104896, y = c(SKN8105194, STDY7388998, STDY7389006, STDY7389014), add.cell.ids = ls()[1:5], project = "lymphocyte")
```



Normalisation with SCTransform
```{r}
lymp <- SCTransform(lymp, vars.to.regress = "mitopercentage", method = "glmGamPoi", verbose = TRUE)
```

```{r}
lymp <- RunPCA(object = lymp, assay = "SCT", features = VariableFeatures(object = lymp), npcs = 50)

DimPlot(object = lymp, reduction = "pca", pt.size = .1, group.by = "orig.ident")
```

# First without harmony integration:
```{r}
lymp <- FindNeighbors(object = lymp, reduction = "pca", dims = 1:20)
lymp <- FindClusters(object = lymp, resolution = c(0.6, 1.0))
Idents(object = lymp) <- "SCT_snn_res.1"
lymp <- RunUMAP(object = lymp, reduction = 'pca', dims = 1:20)
```
```{r}
DimPlot(lymp, reduction = "umap", label = TRUE, label.size = 3)
```

```{r}
DimPlot(lymp, reduction = "umap", label = TRUE, label.size = 3, group.by = "orig.ident")
```



## Now with Harmony integration

```{r}
lymp <- RunHarmony(object = lymp,
                 assay.use = 'SCT',
                 reduction = "pca",
                 group.by.vars = "orig.ident",
                 plot_convergence = TRUE,
                 epsilon.cluster = -Inf,
                 epsilon.harmony = -Inf)
```


```{r}
lymp <- FindNeighbors(object = lymp, reduction = "harmony", dims = 1:20)
#lymp <- FindClusters(object = lymp, resolution = c(0.6, 1.0))
#Idents(object = lymp) <- "SCT_snn_res.1"
lymp <- RunUMAP(object = lymp, reduction = 'harmony', dims = 1:20)
```


```{r}
DimPlot(lymp, reduction = "umap", label = TRUE, label.size = 3)
```


```{r}
DimPlot(lymp, reduction = "umap", label = TRUE, label.size = 3, group.by = "orig.ident")
```


















### EXTRA info >> was trying to write function to filter all object at once
########################################################################################################################
```{r}
seurat_workflow <- function(sample_ID){
  
  ID <- as.character(sample_ID)
  
  s_object <- CreateSeuratObject(counts = sample_ID, project = ID, min.cells = 3, min.features = 200)
  s_object$mitopercentage <- PercentageFeatureSet(s_object, pattern = "^MT-")
  s_object <- subset(s_object, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(s_object$nFeature_RNA)*3)+median(s_object$nFeature_RNA) & mitopercentage < 10)
  
  return(s_object)
}
```

```{r}
for(i in obj.list[1]){
  ID <- as.character(i)
  
  s_object <- CreateSeuratObject(counts = i, project = ID, min.cells = 3, min.features = 200)
  s_object$mitopercentage <- PercentageFeatureSet(s_object, pattern = "^MT-")
  s_object <- subset(s_object, subset = nFeature_RNA > 200 & nFeature_RNA < sum(sd(s_object$nFeature_RNA)*3)+median(s_object$nFeature_RNA) & mitopercentage < 10)
  return(s_object)
} 
```

```{r}
obj.list <- list(SKN8104896, SKN8105194, STDY7388998, STDY7389006, STDY7389014)

lapply(obj.list[[1]], function(x){
  assign(x, seurat_workflow(x))
})
```
Error: vector memory exhausted (limit reached?) >>>still error
########################################################################################################################



























